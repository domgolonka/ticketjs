/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */

!function(exports){function jsonParse(str){try{return JSON&&JSON.parse?JSON.parse(str):new Function("return "+str)()}catch(e){te("ijs")}}function te(ec){throw new Error(errorCodes[ec])}function isArray(o){return Array.isArray?Array.isArray(o):"[object Array]"===toString.call(o)}function mytypeof(o){if(null===o)return"null";var to=typeof o;return"object"===to&&isArray(o)&&(to="array"),to}function mn(node,sel,id,num,tot){var mod,sels=[],cs=">"===sel[0]?sel[1]:sel[0],m=!0;return cs.type&&(m=m&&cs.type===mytypeof(node)),cs.id&&(m=m&&cs.id===id),m&&cs.pf&&(":nth-last-child"===cs.pf?num=tot-num:num++,0===cs.a?m=cs.b===num:(mod=(num-cs.b)%cs.a,m=!mod&&num*cs.a+cs.b>=0)),">"!==sel[0]&&":root"!==sel[0].pc&&sels.push(sel),m&&(">"===sel[0]?sel.length>2&&(m=!1,sels.push(sel.slice(2))):sel.length>1&&(m=!1,sels.push(sel.slice(1)))),[m,sels]}function forEach(sel,obj,fun,id,num,tot){var k,x,a=","===sel[0]?sel.slice(1):[sel],a0=[],call=!1,i=0,j=0,l=0;for(i=0;i<a.length;i++)for(x=mn(obj,a[i],id,num,tot),x[0]&&(call=!0),j=0;j<x[1].length;j++)a0.push(x[1][j]);if(a0.length&&"object"==typeof obj)if(a0.length>=1&&a0.unshift(","),isArray(obj))for(i=0;i<obj.length;i++)forEach(a0,obj[i],fun,void 0,i,obj.length);else{l=0;for(k in obj)obj.hasOwnProperty(k)&&l++;i=0;for(k in obj)obj.hasOwnProperty(k)&&forEach(a0,obj[k],fun,k,i++,l)}call&&fun&&fun(obj)}function match(sel,obj){var a=[];return forEach(sel,obj,function(x){a.push(x)}),a}function compile(sel){return{sel:parse(sel),match:function(obj){return match(this.sel,obj)},forEach:function(obj,fun){return forEach(this.sel,obj,fun)}}}var toString=Object.prototype.toString,errorCodes={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},toks={psc:1,psf:2,typ:3,str:4},pat=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,exprPat=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,lex=function(str,off){off||(off=0);var m=pat.exec(str.substr(off));if(!m)return void 0;off+=m[0].length;var a;return m[1]?a=[off," "]:m[2]?a=[off,m[0]]:m[3]?a=[off,toks.typ,m[0]]:m[4]?a=[off,toks.psc,m[0]]:m[5]?a=[off,toks.psf,m[0]]:m[6]?te("upc"):m[7]?a=[off,toks.str,jsonParse(m[0])]:m[8]?te("ujs"):m[9]&&(a=[off,toks.str,m[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),a},parse=function(str){for(var am,a=[],off=0;;){var s=parse_selector(str,off);if(a.push(s[1]),s=lex(str,off=s[0]),s&&" "===s[1]&&(s=lex(str,off=s[0])),!s)break;">"===s[1]?(a.push(">"),off=s[0]):","===s[1]&&(void 0===am?am=[",",a]:am.push(a),a=[],off=s[0])}return am&&am.push(a),am?am:a},parse_selector=function(str,off){var soff=off,s={},l=lex(str,off);for(l&&" "===l[1]&&(soff=off=l[0],l=lex(str,off)),l&&l[1]===toks.typ?(s.type=l[2],l=lex(str,off=l[0])):l&&"*"===l[1]&&(l=lex(str,off=l[0]));;){if(void 0===l)break;if("."===l[1])l=lex(str,off=l[0]),l&&l[1]===toks.str||te("sra"),s.id&&te("nmi"),s.id=l[2];else if(l[1]===toks.psc)(s.pc||s.pf)&&te("mpc"),":first-child"===l[2]?(s.pf=":nth-child",s.a=0,s.b=1):":last-child"===l[2]?(s.pf=":nth-last-child",s.a=0,s.b=1):s.pc=l[2];else{if(l[1]!==toks.psf)break;(s.pc||s.pf)&&te("mpc"),s.pf=l[2];var m=exprPat.exec(str.substr(l[0]));m||te("mepf"),m[5]?(s.a=2,s.b="odd"===m[5]?1:0):m[6]?(s.a=0,s.b=parseInt(m[6],10)):(s.a=parseInt((m[1]?m[1]:"+")+(m[2]?m[2]:"1"),10),s.b=m[3]?parseInt(m[3]+m[4],10):0),l[0]+=m[0].length}l=lex(str,off=l[0])}return soff===off&&te("se"),[off,s]};exports._lex=lex,exports._parse=parse,exports.match=function(sel,obj){return compile(sel).match(obj)},exports.forEach=function(sel,obj,fun){return compile(sel).forEach(obj,fun)},exports.compile=compile}("undefined"==typeof exports?window.JSONSelect={}:exports);